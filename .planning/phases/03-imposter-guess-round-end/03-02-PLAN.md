---
phase: 03-imposter-guess-round-end
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - web-player/index.html
  - web-player/js/games/imposter.js
  - web-player/css/style.css
autonomous: true

must_haves:
  truths:
    - "Imposters see a text input field to submit word guesses at any time"
    - "Wrong guess shows brief 'Incorrect' feedback then clears input"
    - "Correct guess transitions all players to round-end screen"
    - "Round-end screen shows winner, secret word, imposter list, and scores"
    - "Non-imposter players do NOT see the guess input field"
    - "After round-end display, game resets for a new round"
  artifacts:
    - path: "web-player/index.html"
      provides: "Guess input section as sibling to views, round-end view with scores"
      contains: "imposter-guess-input"
    - path: "web-player/js/games/imposter.js"
      provides: "Guess submission handler, round-end display, score updates, toggleGuessSection"
      contains: "handleRoundEnd"
    - path: "web-player/css/style.css"
      provides: "Styles for guess input, round-end screen, score display"
      contains: "guess-input"
  key_links:
    - from: "web-player/js/games/imposter.js"
      to: "gameSocket.send('word_guess')"
      via: "guess input submit handler"
      pattern: "word_guess"
    - from: "web-player/js/games/imposter.js"
      to: "gameSocket.on('round_end')"
      via: "socket handler for round end"
      pattern: "round_end"
    - from: "web-player/js/games/imposter.js"
      to: "gameSocket.on('guess_result')"
      via: "socket handler for wrong guess feedback"
      pattern: "guess_result"
---

<objective>
Add word guess UI for imposters, round-end display for all players, and score tracking to the web player.

Purpose: Imposters need a text input to submit word guesses anytime (during discussion, voting, and consensus). All players need to see round-end results (winner, word, imposter reveals, team scores). The UI must handle guess feedback (wrong = toast, correct = round ends).
Output: Updated index.html with guess input and round-end view, updated imposter.js with guess/round-end handlers, updated style.css with new styles.
</objective>

<execution_context>
@/Users/adamgrow/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamgrow/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-imposter-guess-round-end/03-CONTEXT.md
@web-player/index.html
@web-player/js/games/imposter.js
@web-player/css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add guess input and round-end HTML + CSS</name>
  <files>web-player/index.html, web-player/css/style.css</files>
  <action>
1. In index.html, add a guess input section as a SIBLING to the view divs inside `screen-imposter`. Place it AFTER the last view div (`imposter-result-view`) but BEFORE the round-end view. This placement makes it independent of view switching so it can be shown during any active phase (discussion, voting, consensus).

```html
<!-- Guess input (imposters only, toggled by JS independently of views) -->
<div id="imposter-guess-section" class="guess-section hidden">
    <p class="guess-label">Guess the word:</p>
    <div class="guess-input-row">
        <input type="text" id="imposter-guess-input" class="guess-input" placeholder="Enter your guess..." autocomplete="off" />
        <button id="imposter-guess-btn" class="btn-guess">Guess</button>
    </div>
    <p id="guess-feedback" class="guess-feedback hidden"></p>
</div>
```

2. In index.html, add a new round-end view div AFTER the guess section, still inside `screen-imposter` (before the closing `</div>` of screen-imposter):

```html
<!-- Round End View -->
<div id="imposter-round-end-view" class="game-content hidden">
    <div id="round-end-card" class="round-end-card">
        <h2 id="round-end-winner" class="round-end-winner">IMPOSTERS WIN!</h2>
        <p id="round-end-word" class="round-end-word">The word was: ???</p>
        <div id="round-end-imposters" class="round-end-imposters">
            <p class="imposters-label">The imposters were:</p>
            <p id="round-end-imposter-names" class="imposter-names">???</p>
        </div>
        <div class="round-end-scores">
            <span id="round-end-imposter-score" class="team-score imposter-score">Imposters: 0</span>
            <span class="score-divider">|</span>
            <span id="round-end-innocent-score" class="team-score innocent-score">Innocents: 0</span>
        </div>
    </div>
</div>
```

The final structure inside screen-imposter should be:
- game-header
- imposter-role-view
- imposter-voting-view
- imposter-spectator-view
- imposter-consensus-view
- imposter-reveal-view
- imposter-result-view
- imposter-guess-section (NOT a view -- toggled independently by JS)
- imposter-round-end-view

3. In style.css, add styles at the bottom (after existing imposter styles):

```css
/* ============ IMPOSTER GUESS STYLES ============ */

.guess-section {
    margin-top: 1rem;
    padding: 1rem;
    border-top: 1px solid rgba(255,255,255,0.15);
}

.guess-label {
    color: #ff6b6b;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.guess-input-row {
    display: flex;
    gap: 0.5rem;
}

.guess-input {
    flex: 1;
    padding: 0.75rem;
    border-radius: 8px;
    border: 2px solid rgba(255,107,107,0.3);
    background: rgba(0,0,0,0.3);
    color: white;
    font-size: 1rem;
    outline: none;
}

.guess-input:focus {
    border-color: #ff6b6b;
}

.btn-guess {
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    border: none;
    background: #ff6b6b;
    color: white;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
}

.btn-guess:active {
    background: #e05555;
}

.guess-feedback {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    text-align: center;
    color: #ff6b6b;
    font-weight: bold;
}

/* ============ ROUND END STYLES ============ */

.round-end-card {
    text-align: center;
    padding: 2rem 1rem;
    border-radius: 16px;
    margin: 1rem;
}

.round-end-card.imposters-win {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
}

.round-end-card.innocents-win {
    background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
}

.round-end-winner {
    font-size: 2rem;
    color: white;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 2px;
}

.round-end-word {
    font-size: 1.5rem;
    color: rgba(255,255,255,0.9);
    margin-bottom: 1.5rem;
}

.round-end-imposters {
    margin-bottom: 1.5rem;
}

.imposters-label {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.7);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 0.25rem;
}

.imposter-names {
    font-size: 1.2rem;
    color: white;
    font-weight: bold;
}

.round-end-scores {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.2);
}

.team-score {
    font-size: 1.1rem;
    font-weight: bold;
}

.imposter-score {
    color: #ff6b6b;
}

.innocent-score {
    color: #6bb5ff;
}

.score-divider {
    color: rgba(255,255,255,0.4);
    font-size: 1.2rem;
}
```

Important: The guess-section is NOT inside any view div. It is a sibling element toggled independently by JavaScript. The `showView()` method does NOT manage it. A separate `toggleGuessSection()` method will control its visibility (implemented in Task 2).
  </action>
  <verify>
  Open web-player/index.html and verify:
  - imposter-guess-section div exists as a SIBLING to the view divs (not inside any view), with hidden class
  - imposter-guess-input, imposter-guess-btn, and guess-feedback elements exist
  - imposter-round-end-view div exists inside screen-imposter as the last view
  - round-end-card, round-end-winner, round-end-word, round-end-imposter-names, score elements exist

  Open web-player/css/style.css and verify:
  - .guess-section, .guess-input, .btn-guess styles exist
  - .round-end-card, .round-end-winner, .round-end-word styles exist
  - .imposters-win and .innocents-win gradient backgrounds defined
  </verify>
  <done>
  HTML has guess input as independent section (sibling to views, hidden by default), round-end view with winner/word/imposters/scores, and CSS styles for both new UI elements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add guess submission and round-end handlers to JavaScript</name>
  <files>web-player/js/games/imposter.js</files>
  <action>
Update the ImposterGame class in imposter.js with these changes:

1. Add `imposter-round-end-view` to the views array in `showView()` method (add after 'imposter-result-view'). Total should be 7 views.

2. Add new socket handlers in `setupSocketHandlers()`:
   ```javascript
   gameSocket.on('guess_result', (data) => {
       this.handleGuessResult(data);
   });

   gameSocket.on('round_end', (data) => {
       this.handleRoundEnd(data);
   });

   gameSocket.on('round_restart', (data) => {
       this.handleRoundRestart(data);
   });
   ```

3. Create `toggleGuessSection(show)` method. This controls the guess input independently of view switching:
   ```javascript
   toggleGuessSection(show) {
       const section = document.getElementById('imposter-guess-section');
       if (section) {
           if (show) {
               section.classList.remove('hidden');
           } else {
               section.classList.add('hidden');
           }
       }
   }
   ```

4. Create `setupGuessInput()` method:
   ```javascript
   setupGuessInput() {
       const btn = document.getElementById('imposter-guess-btn');
       const input = document.getElementById('imposter-guess-input');
       if (!btn || !input) return;

       // Remove existing listeners by cloning button
       const newBtn = btn.cloneNode(true);
       btn.parentNode.replaceChild(newBtn, btn);

       newBtn.addEventListener('click', () => {
           this.submitGuess();
       });

       // Submit on Enter key
       input.addEventListener('keydown', (e) => {
           if (e.key === 'Enter') {
               this.submitGuess();
           }
       });
   }
   ```

5. Create `submitGuess()` method:
   ```javascript
   submitGuess() {
       const input = document.getElementById('imposter-guess-input');
       if (!input) return;

       const guess = input.value.trim();
       if (guess === '') return;

       gameSocket.send('word_guess', { guess: guess });
       input.value = '';
   }
   ```

6. Create `handleGuessResult(data)` method:
   ```javascript
   handleGuessResult(data) {
       if (!data.correct) {
           const feedback = document.getElementById('guess-feedback');
           if (feedback) {
               feedback.textContent = 'Incorrect!';
               feedback.classList.remove('hidden');
               setTimeout(() => {
                   feedback.classList.add('hidden');
               }, 2000);
           }
       }
   }
   ```

7. Create `handleRoundEnd(data)` method:
   ```javascript
   handleRoundEnd(data) {
       this.currentState = 'round_end';
       this.toggleGuessSection(false);
       this.showView('imposter-round-end-view');

       const winnerEl = document.getElementById('round-end-winner');
       const wordEl = document.getElementById('round-end-word');
       const namesEl = document.getElementById('round-end-imposter-names');
       const card = document.getElementById('round-end-card');
       const imposterScoreEl = document.getElementById('round-end-imposter-score');
       const innocentScoreEl = document.getElementById('round-end-innocent-score');

       if (winnerEl) {
           winnerEl.textContent = data.winner === 'imposters' ? 'IMPOSTERS WIN!' : 'INNOCENTS WIN!';
       }
       if (wordEl) {
           wordEl.textContent = 'The word was: ' + (data.word || '???');
       }
       if (namesEl && data.imposter_names) {
           namesEl.textContent = data.imposter_names.join(', ');
       }
       if (card) {
           card.className = data.winner === 'imposters'
               ? 'round-end-card imposters-win'
               : 'round-end-card innocents-win';
       }
       if (imposterScoreEl && data.scores) {
           imposterScoreEl.textContent = 'Imposters: ' + (data.scores.imposters || 0);
       }
       if (innocentScoreEl && data.scores) {
           innocentScoreEl.textContent = 'Innocents: ' + (data.scores.innocents || 0);
       }
   }
   ```

8. Create `handleRoundRestart(data)` method:
   ```javascript
   handleRoundRestart(data) {
       this.currentState = '';
       this.votes = {};
       this.tallies = {};
       this.myVote = null;
       this.consensusTarget = null;
       this.countdown = 5;
       this.isEliminated = false;
       this.toggleGuessSection(false);

       const input = document.getElementById('imposter-guess-input');
       if (input) input.value = '';
       const feedback = document.getElementById('guess-feedback');
       if (feedback) feedback.classList.add('hidden');
   }
   ```

9. Update existing methods to call toggleGuessSection at the right times:
   - In `showRoleScreen()`: Add at the END of the method (after showView call):
     `this.toggleGuessSection(this.isImposter);`
     Also add: `this.setupGuessInput();`
   - In `showVotingView()`: Add after showView call:
     `this.toggleGuessSection(this.isImposter);`
   - In `showSpectatorView()`: Add after showView call:
     `this.toggleGuessSection(false);`
   - In `handleConsensusWarning()`: Add after showView call:
     `this.toggleGuessSection(this.isImposter && !this.isEliminated);`
   - In `handleRevealStart()`: Add after showView call:
     `this.toggleGuessSection(false);`

This ensures imposters see the guess input during discussion, voting, and consensus phases, but NOT during reveal or round-end. Non-imposters and eliminated players never see it.
  </action>
  <verify>
  Open web-player/js/games/imposter.js and verify:
  - showView array includes 'imposter-round-end-view' (7 total views)
  - setupSocketHandlers has guess_result, round_end, round_restart handlers
  - toggleGuessSection method exists and controls imposter-guess-section visibility
  - setupGuessInput method exists with click and Enter key handlers
  - submitGuess sends word_guess message via gameSocket
  - handleGuessResult shows "Incorrect!" feedback for 2 seconds on wrong guess
  - handleRoundEnd displays winner, word, imposter names, scores with gradient card
  - handleRoundRestart resets all state for new round
  - showRoleScreen calls toggleGuessSection(this.isImposter) and setupGuessInput()
  - showVotingView calls toggleGuessSection(this.isImposter)
  - showSpectatorView calls toggleGuessSection(false)
  - handleConsensusWarning calls toggleGuessSection(this.isImposter && !this.isEliminated)
  - handleRevealStart calls toggleGuessSection(false)
  </verify>
  <done>
  Imposters see guess input during all active phases (discussion, voting, consensus). Wrong guesses show 2-second "Incorrect!" feedback. Correct guesses trigger round-end screen showing winner, word, imposter reveals, and team scores. Round restart clears all state. Non-imposters and eliminated players never see the guess input.
  </done>
</task>

</tasks>

<verification>
- Imposter players see guess input field on their screens during active gameplay (discussion, voting, consensus)
- Guess input stays visible when switching between discussion, voting, and consensus views
- Non-imposter players do NOT see guess input field at any time
- Eliminated players do NOT see guess input field
- Submitting a wrong guess shows "Incorrect!" for 2 seconds, no other effect
- Submitting a correct guess shows round-end screen for ALL players
- Round-end screen displays: winner team, secret word, imposter player names, team scores
- Round-end card has red gradient for imposter win, blue for innocent win
- After round-end, game resets for new round with new roles
- Team scores persist across rounds
</verification>

<success_criteria>
- GUESS-01: Text input with submit button visible to imposters during active phases, sends word_guess message
- GUESS-02: round_end handler shows "IMPOSTERS WIN!" with red gradient on correct guess
- GUESS-03: guess_result handler shows "Incorrect!" toast, input clears, no state change
- END-01: round_end handler shows "INNOCENTS WIN!" with blue gradient when all imposters found
- END-02: round_end triggered by both correct guess and all-imposters-eliminated
- END-03: Scores display in round-end view, persist across round restarts
</success_criteria>

<output>
After completion, create `.planning/phases/03-imposter-guess-round-end/03-02-SUMMARY.md`
</output>
