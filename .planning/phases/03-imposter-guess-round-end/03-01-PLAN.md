---
phase: 03-imposter-guess-round-end
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/games/imposter.gd
autonomous: true

must_haves:
  truths:
    - "Host processes imposter word guess and broadcasts result"
    - "Correct guess immediately ends round with imposters winning"
    - "Wrong guess has no penalty and game continues"
    - "Round ends when all imposters are eliminated via voting"
    - "Win scores tracked across rounds and broadcast with round-end"
    - "Host can start a new round after round-end display"
  artifacts:
    - path: "scripts/games/imposter.gd"
      provides: "Guess processing, round-end detection, win tracking, round restart"
      contains: "word_guess"
  key_links:
    - from: "scripts/games/imposter.gd"
      to: "NetworkManager.broadcast"
      via: "round_end message with winner, word, scores"
      pattern: "round_end"
    - from: "scripts/games/imposter.gd"
      to: "_after_reveal"
      via: "all-imposters-found detection triggers round end"
      pattern: "remaining_imposters.*==.*0"
    - from: "scripts/games/imposter.gd"
      to: "_process_word_guess"
      via: "correct guess triggers immediate round end"
      pattern: "current_word"
---

<objective>
Add word guess processing, round-end detection, win tracking, and round restart to the Godot host controller.

Purpose: The host must handle imposter word guesses (correct = imposters win immediately, wrong = no penalty), detect when all imposters are eliminated (innocents win), track team scores across rounds, and support starting new rounds.
Output: Extended imposter.gd with guess processing, round-end logic, score tracking, and new round support.
</objective>

<execution_context>
@/Users/adamgrow/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamgrow/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-imposter-guess-round-end/03-CONTEXT.md
@scripts/games/imposter.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add word guess processing and round-end detection</name>
  <files>scripts/games/imposter.gd</files>
  <action>
Add word guess processing to the existing imposter.gd host controller:

1. Add new state variables at top of file:
   - `var scores: Dictionary = {"imposters": 0, "innocents": 0}` - persists across rounds
   - Add `ROUND_END` to the State enum (after RESULT_DISPLAY)

2. Add "word_guess" case to the `_on_message_received` match block:
   ```
   "word_guess":
       if GameManager.is_host:
           var guesser_id = "peer_%d" % _peer_id
           _process_word_guess(guesser_id, data.get("guess", ""))
   ```

3. Create `_process_word_guess(guesser_id: String, guess: String)` function:
   - Only process if guesser is an imposter: `if not player_roles.get(guesser_id, false): return`
   - Only process if guesser is not eliminated: `if guesser_id in eliminated_players: return`
   - Only process during active gameplay (not ROUND_END or REVEALING states)
   - Compare guess case-insensitively: `if guess.strip_edges().to_lower() == current_word.to_lower()`
   - If correct: call `_end_round("imposters", guesser_id)`
   - If wrong: broadcast `guess_result` with `{"type": "guess_result", "correct": false, "guesser_id": guesser_id}`

4. Modify `_after_reveal()` to detect all-imposters-found:
   - Replace the existing "Phase 3 will handle this" comment block
   - If `remaining_imposters <= 0`: call `_end_round("innocents", "")`
   - Else if `_get_eligible_voters().size() > 2`: resume voting (keep existing behavior)
   - Else: call `_end_round("innocents", "")` (not enough players to continue)

5. Create `_end_round(winner: String, guesser_id: String)` function:
   - Set `current_state = State.ROUND_END`
   - Stop timers: `countdown_timer.stop()` and `consensus_check_timer.stop()`
   - Increment score: `scores[winner] += 1`
   - Build imposter names list for reveal
   - Broadcast round_end message:
     ```
     NetworkManager.broadcast({
         "type": "round_end",
         "winner": winner,
         "word": current_word,
         "imposters": imposters,
         "imposter_names": imposter_names,
         "guesser_id": guesser_id,
         "scores": scores
     })
     ```
   - After 5-second timer (`await get_tree().create_timer(5.0).timeout`), call `_return_to_lobby()`

6. Create `_return_to_lobby()` function:
   - Broadcast `{"type": "round_restart"}`
   - Reset round state: clear votes, eliminated_players, player_roles, imposters, consensus_target
   - Set `current_state = State.DISCUSSION`
   - Call `_initialize_game()` to start fresh round with new word/roles
   - Do NOT reset scores (they persist across rounds)

7. Add "round_restart" and "round_end" to the match block in `_on_message_received` for non-host clients to handle state sync (similar to existing apply functions).

Important: The guess comparison must be case-insensitive and strip whitespace. Use `guess.strip_edges().to_lower() == current_word.to_lower()`.

Important: Correct guess takes priority - it can happen during ANY active state (DISCUSSION, VOTING, CONSENSUS_WARNING). Only block during REVEALING and ROUND_END.
  </action>
  <verify>
  Open scripts/games/imposter.gd and verify:
  - State enum includes ROUND_END
  - scores Dictionary exists with imposters/innocents keys
  - "word_guess" case exists in message handler match block
  - _process_word_guess function exists with case-insensitive comparison
  - _end_round function broadcasts round_end message with winner, word, scores
  - _after_reveal checks remaining_imposters <= 0 and calls _end_round
  - _return_to_lobby resets round state but preserves scores
  </verify>
  <done>
  Host processes word guesses (correct = imposters win, wrong = no penalty), detects all-imposters-eliminated (innocents win), tracks scores across rounds, and auto-starts new round after 5-second display.
  </done>
</task>

</tasks>

<verification>
- imposter.gd has ROUND_END state and scores tracking
- _process_word_guess handles correct/wrong guesses
- _end_round broadcasts winner, word, imposter list, and scores
- _after_reveal triggers round end when remaining_imposters hits 0
- _return_to_lobby resets round state without resetting scores
- Guess processing blocked during REVEALING and ROUND_END states
</verification>

<success_criteria>
- GUESS-01: word_guess message handled by host (guesser validation, comparison)
- GUESS-02: Correct guess calls _end_round("imposters") immediately
- GUESS-03: Wrong guess broadcasts guess_result with correct: false, no state change
- END-01: _after_reveal detects remaining_imposters <= 0 and ends round
- END-02: _end_round("imposters") triggered by correct guess
- END-03: scores dictionary incremented per round, included in round_end broadcast
</success_criteria>

<output>
After completion, create `.planning/phases/03-imposter-guess-round-end/03-01-SUMMARY.md`
</output>
