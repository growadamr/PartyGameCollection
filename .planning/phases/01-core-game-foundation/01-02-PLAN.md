---
phase: 01-core-game-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/games/imposter.gd
  - scenes/games/imposter/imposter.tscn
  - scripts/lobby/game_select.gd
autonomous: true

must_haves:
  truths:
    - "Host can select Imposter game from game selection menu"
    - "Imposter count is 1 for 4-5 players, 2 for 6-8 players"
    - "Non-imposter players receive the secret word"
    - "Imposter players receive 'IMPOSTER' label instead of word"
    - "Discussion phase displays role info without enforced structure"
  artifacts:
    - path: "scripts/games/imposter.gd"
      provides: "Host-authoritative game controller"
      exports: "_initialize_game, _on_message_received"
      min_lines: 100
    - path: "scenes/games/imposter/imposter.tscn"
      provides: "Game scene with UI layout"
      contains: "Control node with script reference"
    - path: "scripts/lobby/game_select.gd"
      provides: "Game menu with Imposter option"
      contains: 'imposter'
  key_links:
    - from: "scripts/games/imposter.gd"
      to: "NetworkManager.send_to_client"
      via: "personalized role messages"
      pattern: "send_to_client.*imposter_role"
    - from: "scripts/games/imposter.gd"
      to: "data/prompts/imposter_words.json"
      via: "FileAccess.open"
      pattern: "imposter_words\\.json"
    - from: "scripts/lobby/game_select.gd"
      to: "scenes/games/imposter/imposter.tscn"
      via: "scene path in GAMES array"
---

<objective>
Create the Godot host-side implementation for the Imposter game including game controller, scene, and menu integration.

Purpose: Implement host-authoritative game logic that assigns roles (imposter vs non-imposter), selects secret words, and manages the discussion phase. The host controls all game state; players only display UI.

Output: Working Imposter game selectable from menu. When selected, players receive personalized role data and see discussion phase UI on host device.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-game-foundation/01-RESEARCH.md

# Reference implementation to follow
@scripts/games/charades.gd
@scenes/games/charades/charades.tscn
@scripts/lobby/game_select.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Imposter game controller</name>
  <files>scripts/games/imposter.gd</files>
  <action>
Create `scripts/games/imposter.gd` following the charades.gd pattern:

1. **Script structure:**
   - `extends Control`
   - @onready references to UI nodes (will match scene)
   - Game state variables: words array, current_word, imposters array, player_roles dict

2. **_ready() function:**
   - Connect to NetworkManager.message_received signal
   - Load words via _load_words()
   - Call deferred _initialize_game()

3. **_load_words() function:**
   - Use FileAccess.open("res://data/prompts/imposter_words.json", FileAccess.READ)
   - Parse with JSON.parse_string()
   - Return array of words (fallback to ["apple", "banana", "car", "house", "tree"] if file missing)

4. **_initialize_game() function (HOST ONLY):**
   - Guard: `if not GameManager.is_host: return`
   - Get player_ids from GameManager.players.keys()
   - Calculate imposter_count using _get_imposter_count(player_count)
   - Shuffle player_ids, select first N as imposters
   - Select random word from words array
   - For each player: send PERSONALIZED role data via NetworkManager.send_to_client()
     - Message type: "imposter_role"
     - Fields: is_imposter (bool), word (string - empty if imposter), imposter_count, total_players
   - Broadcast discussion phase start (type: "discussion_started")
   - Update host UI to show discussion phase

5. **_get_imposter_count(player_count: int) -> int:**
   - 6-8 players: return 2
   - 4-5 players: return 1
   - Less than 4: return 1 (minimum)

6. **_get_peer_id_for_player(player_id: String) -> int:**
   - Parse "peer_N" format: `return int(player_id.substr(5))`

7. **_on_message_received(_peer_id: int, data: Dictionary):**
   - Match on data.get("type", "")
   - Handle: "imposter_role" -> _apply_role_data(data)
   - Handle: "discussion_started" -> _show_discussion_phase()

8. **_apply_role_data(data: Dictionary):**
   - Store is_imposter, word, imposter_count locally
   - Update UI to show role

9. **_show_discussion_phase():**
   - Update host UI labels
   - Show imposter count to all ("There are X imposters among you")

10. **Host UI update helpers:**
    - _update_players_display() - show all players with their colors (similar to charades)

CRITICAL: Use send_to_client() for role data, NOT broadcast(). This prevents cheating via network inspection.
  </action>
  <verify>
- File exists at `scripts/games/imposter.gd`
- Script compiles (Godot editor shows no errors)
- Contains _get_imposter_count function with correct logic
- Contains send_to_client calls (not broadcast) for role data
  </verify>
  <done>
`imposter.gd` exists with host-authoritative role assignment, personalized messaging, and discussion phase logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Imposter game scene</name>
  <files>scenes/games/imposter/imposter.tscn</files>
  <action>
Create `scenes/games/imposter/imposter.tscn` following charades.tscn structure:

1. **Root node:** Control named "Imposter" with script reference to imposter.gd
   - layout_mode = 3, anchors_preset = 15 (full rect)

2. **Background:** ColorRect covering full screen
   - Color: Color(0.1, 0.08, 0.12, 1) (dark purple, matches other games)

3. **VBox:** Main container with margins (40px sides, 60px top, 40px bottom)

4. **Header section (HBox):**
   - GameTitle Label: "Imposter" (font_size 24)
   - Spacer (size_flags_horizontal = 3)
   - ImposterCountLabel: "? Imposters" (font_size 18, color gray)

5. **Role display section:**
   - RoleLabel: "You are..." (font_size 28, centered)
   - WordDisplay (PanelContainer with Label inside):
     - Large text area for word/"IMPOSTER" (font_size 48, centered)

6. **Instruction section:**
   - InstructionLabel: "Discuss with your group!" (font_size 18, gray)

7. **Players status section (HBox):**
   - Will be populated dynamically with player colors/names

Node names must match @onready references in imposter.gd:
- `$VBox/Header/ImposterCountLabel`
- `$VBox/RoleSection/RoleLabel`
- `$VBox/RoleSection/WordDisplay/WordLabel`
- `$VBox/InstructionLabel`
- `$VBox/PlayersStatus`
  </action>
  <verify>
- File exists at `scenes/games/imposter/imposter.tscn`
- Scene can be opened in Godot editor without errors
- Script reference points to `res://scripts/games/imposter.gd`
  </verify>
  <done>
Scene file exists with correct structure, all node names match script @onready references.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Imposter to game selection menu</name>
  <files>scripts/lobby/game_select.gd</files>
  <action>
Edit `scripts/lobby/game_select.gd` to add Imposter game to the GAMES array:

Add new entry to GAMES const array (suggest position after charades for thematic grouping):

```gdscript
{
    "id": "imposter",
    "name": "Imposter",
    "description": "Find the imposter! One player doesn't know the secret word.",
    "icon": "üïµÔ∏è",
    "min_players": 4,
    "color": Color(0.4, 0.3, 0.6)
}
```

Notes:
- min_players: 4 (game needs at least 4 to have meaningful deduction)
- color: Purple tone to distinguish from other games
- The existing _on_game_selected() function already handles scene loading via path pattern `res://scenes/games/{id}/{id}.tscn` - no additional changes needed

Verify the scene path pattern matches: `res://scenes/games/imposter/imposter.tscn`
  </action>
  <verify>
- `grep -n "imposter" scripts/lobby/game_select.gd` shows the new entry
- Game appears in selection menu when running the project
- Clicking Imposter (with 4+ players) loads the imposter scene
  </verify>
  <done>
Imposter game appears in game selection menu with correct metadata.
  </done>
</task>

</tasks>

<verification>
- [ ] `scripts/games/imposter.gd` compiles without errors
- [ ] `scenes/games/imposter/imposter.tscn` opens in editor without errors
- [ ] Game appears in selection menu
- [ ] Role assignment uses send_to_client (not broadcast) for personalized data
- [ ] Imposter count logic: 1 for 4-5 players, 2 for 6-8 players
- [ ] Word loaded from imposter_words.json
</verification>

<success_criteria>
1. Host can select Imposter from game menu (SETUP-01)
2. Imposter count scales correctly (SETUP-02)
3. Role assignment sends personalized data (SETUP-03 host side)
4. Word selected from compiled list (SETUP-04)
5. Discussion phase shows role info (DISC-01, DISC-02 host side)
6. Files created at correct paths (INT-01, INT-02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-game-foundation/01-02-SUMMARY.md`
</output>
